<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tron Multiplayer Game</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }
    canvas {
      display: block;
      background: #111;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas"></canvas>

  <script type="module">
    // Import Firebase modules from the CDN
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-analytics.js";
    import { getDatabase, ref, onValue, set, update, onDisconnect } from "https://www.gstatic.com/firebasejs/11.6.0/firebase-database.js";

    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyAuWY5GDgH2_-iiNCluN89cjsip19qIpGM",
      authDomain: "fortnite-64ecb.firebaseapp.com",
      databaseURL: "https://fortnite-64ecb-default-rtdb.firebaseio.com",
      projectId: "fortnite-64ecb",
      storageBucket: "fortnite-64ecb.firebasestorage.app",
      messagingSenderId: "643049506369",
      appId: "1:643049506369:web:15e6e0bbf6bd0462bca8c0",
      measurementId: "G-KGWJWD3Z3C"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);
    const db = getDatabase(app);

    // Full screen canvas setup
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');

    function adjustCanvasSize() {
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
    }
    window.addEventListener('resize', adjustCanvasSize);
    adjustCanvasSize();

    // Generate a random player ID
    let playerId = '_' + Math.random().toString(36).substr(2, 9);

    // Initialize the player's Tron state
    let player = {
      x: canvas.width / 2,
      y: canvas.height / 2,
      direction: 'right',
      trail: []
    };

    // Define movement directions (5 pixels per update)
    const directions = {
      up: { dx: 0, dy: -5 },
      down: { dx: 0, dy: 5 },
      left: { dx: -5, dy: 0 },
      right: { dx: 5, dy: 0 }
    };

    // Listen for arrow key presses (preventing 180Â° turns)
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowUp' && player.direction !== 'down') {
        player.direction = 'up';
      } else if (e.key === 'ArrowDown' && player.direction !== 'up') {
        player.direction = 'down';
      } else if (e.key === 'ArrowLeft' && player.direction !== 'right') {
        player.direction = 'left';
      } else if (e.key === 'ArrowRight' && player.direction !== 'left') {
        player.direction = 'right';
      }
    });

    // Use a fixed lobby ID for all players
    const lobbyId = 'tronLobby';

    // Join the game immediately by setting the player's initial state in Firebase
    function joinGame() {
      const playerRef = ref(db, "lobbies/" + lobbyId + "/players/" + playerId);
      set(playerRef, {
        x: player.x,
        y: player.y,
        direction: player.direction,
        trail: player.trail
      });
      // Remove the player's record when they disconnect
      onDisconnect(playerRef).remove();
    }
    joinGame();

    // Update the player's state: move based on the current direction and update Firebase
    function updatePlayerState() {
      player.x += directions[player.direction].dx;
      player.y += directions[player.direction].dy;

      // Add the new position to the player's trail
      player.trail.push({ x: player.x, y: player.y });

      // Update the player's data in Firebase
      const playerRef = ref(db, "lobbies/" + lobbyId + "/players/" + playerId);
      update(playerRef, {
        x: player.x,
        y: player.y,
        direction: player.direction,
        trail: player.trail
      });
    }

    // Render all players' trails and positions on the canvas
    function renderGame(gameData) {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      if (gameData && gameData.players) {
        for (const id in gameData.players) {
          const p = gameData.players[id];
          // Draw the trail as a continuous line
          if (p.trail && p.trail.length > 0) {
            ctx.beginPath();
            ctx.strokeStyle = (id === playerId) ? "#0f0" : "#f00";
            ctx.lineWidth = 2;
            ctx.moveTo(p.trail[0].x, p.trail[0].y);
            for (let i = 1; i < p.trail.length; i++) {
              ctx.lineTo(p.trail[i].x, p.trail[i].y);
            }
            ctx.stroke();
            ctx.closePath();
          }
          // Draw the current position as a circle
          ctx.beginPath();
          ctx.fillStyle = (id === playerId) ? "#0f0" : "#f00";
          ctx.arc(p.x, p.y, 5, 0, Math.PI * 2);
          ctx.fill();
          ctx.closePath();
        }
      }
    }

    // Listen for updates in the lobby to render the game state in real time
    const lobbyRef = ref(db, "lobbies/" + lobbyId);
    onValue(lobbyRef, (snapshot) => {
      const gameData = snapshot.val();
      renderGame(gameData);
    });

    // Main game loop: update the player's state every 100ms
    setInterval(() => {
      updatePlayerState();
    }, 100);
  </script>
</body>
</html>
